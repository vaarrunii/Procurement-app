<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Procurement Analytics{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-100;
        }
        /* DataTables CSS */
        @import url('https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css');
        @import url('https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css');

        /* Custom styles for rounded corners and shadows, etc. */
        .card {
            @apply bg-white rounded-lg shadow-md p-6;
        }
        .btn {
            @apply inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500;
        }
        .btn-secondary {
            @apply bg-gray-600 hover:bg-gray-700;
        }
        table.dataTable thead th {
            @apply bg-gray-200 text-gray-700 font-semibold text-left p-3;
        }
        table.dataTable tbody td {
            @apply p-3 border-b border-gray-200;
        }
        table.dataTable.no-footer {
            border-bottom: 1px solid #e2e8f0; /* Tailwind gray-200 equivalent */
        }
        div.dataTables_wrapper div.dataTables_filter input {
            @apply rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50;
        }
        div.dataTables_wrapper div.dataTables_length select {
            @apply rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50;
        }
        .dataTables_info {
            @apply text-sm text-gray-600 mt-2;
        }
        .dataTables_paginate .paginate_button {
            @apply px-3 py-1 mx-1 border border-gray-300 rounded-md bg-white hover:bg-gray-50;
        }
        .dataTables_paginate .paginate_button.current {
            @apply bg-indigo-600 text-white border-indigo-600;
        }
        .dataTables_wrapper .dt-buttons {
            /* This class is for DataTables' built-in buttons, which we are not using directly for CSV */
            @apply mb-4;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <nav class="bg-indigo-700 p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <a href="{% url 'home' %}" class="text-white text-2xl font-bold rounded-lg px-3 py-2 hover:bg-indigo-600">Procurement Analytics</a>
            <div class="space-x-4">
                {% if user.is_authenticated %}
                    <a href="{% url 'data_home' %}" class="text-white hover:text-gray-200 rounded-lg px-3 py-2 hover:bg-indigo-600">Data</a>
                    <a href="{% url 'summary_page' %}" class="text-white hover:text-gray-200 rounded-lg px-3 py-2 hover:bg-indigo-600">Summary</a>
                    <span class="text-white mr-2">Welcome, {{ user.username }}!</span>
                    <a href="{% url 'logout' %}" class="btn btn-secondary">Logout</a>
                {% else %}
                    <a href="{% url 'login' %}" class="btn btn-secondary">Login</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <main class="flex-grow container mx-auto p-8">
        {% block content %}
        {% endblock %}
    </main>

    <footer class="bg-gray-800 text-white p-4 mt-8">
        <div class="container mx-auto text-center text-sm">
            &copy; 2025 Procurement Analytics. All rights reserved.
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script> {# For Excel export (if using DT's native) #}
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.print.min.js"></script>
    <script>
        // Custom function to handle CSV export
        function exportTableToCSV(tableId, filename) {
            const table = $('#' + tableId).DataTable();
            let csv = [];
            let header = [];

            // Get table headers (assuming they are in thead th)
            $('#' + tableId + ' thead th').each(function() {
                header.push($(this).text().trim());
            });
            csv.push(header.join(','));

            // Get table data from DataTables' internal data for all rows (visible or not)
            table.rows().every(function() {
                let rowData = this.data();
                let row = [];
                for (let i = 0; i < rowData.length; i++) {
                    let cellValue = rowData[i];
                    // Handle null/undefined values
                    if (cellValue === null || typeof cellValue === 'undefined') {
                        cellValue = '';
                    } else {
                        cellValue = String(cellValue); // Ensure it's a string
                    }

                    // Escape double quotes by doubling them, then wrap in quotes if contains comma or newline
                    let cell = cellValue.replace(/"/g, '""');
                    if (cell.includes(',') || cell.includes('\n')) {
                        cell = `"${cell}"`;
                    }
                    row.push(cell);
                }
                csv.push(row.join(','));
            });

            // Create a Blob and download it
            const csvFile = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const downloadLink = document.createElement("a");
            downloadLink.href = URL.createObjectURL(csvFile);
            downloadLink.download = filename + ".csv";
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }
    </script>
    {% block extra_js %}
    {% endblock %}
</body>
</html>